<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Irrigation Scheduler</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        const Icon = ({ d, size = 24, fill = "none", className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {Array.isArray(d) ? d.map((path, i) => <path key={i} d={path} />) : <path d={d} />}
            </svg>
        );
        
        const Plus = (props) => <Icon d="M12 5v14M5 12h14" {...props} />;
        const Edit2 = (props) => <Icon d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" {...props} />;
        const Trash2 = (props) => <Icon d={["M3 6h18", "M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2", "M10 11v6", "M14 11v6"]} {...props} />;
        const CheckCircle = (props) => <Icon d={["M22 11.08V12a10 10 0 1 1-5.93-9.14", "M22 4 12 14.01l-3-3"]} {...props} />;
        const Bell = (props) => <Icon d={["M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9", "M13.73 21a2 2 0 0 1-3.46 0"]} {...props} />;
        const BellOff = (props) => <Icon d={["M13.73 21a2 2 0 0 1-3.46 0", "M18.63 13A17.89 17.89 0 0 1 18 8", "M6.26 6.26A5.86 5.86 0 0 0 6 8c0 7-3 9-3 9h14", "M18 8a6 6 0 0 0-9.33-5", "M1 1l22 22"]} {...props} />;
        const ChevronDown = (props) => <Icon d="m6 9 6 6 6-6" {...props} />;
        const ChevronRight = (props) => <Icon d="m9 18 6-6-6-6" {...props} />;
        const Pause = (props) => <Icon d={["M6 4h4v16H6z", "M14 4h4v16h-4z"]} {...props} />;
        
        const storage = {
            get: (key) => {
                const item = localStorage.getItem(key);
                return item ? { value: item } : null;
            },
            set: (key, value) => {
                localStorage.setItem(key, value);
                return { key, value };
            },
            delete: (key) => {
                localStorage.removeItem(key);
                return { key, deleted: true };
            }
        };
        
        function IrrigationScheduler() {
            const [pivots, setPivots] = useState([]);
            const [activeSystems, setActiveSystems] = useState([]);
            const [completedHistory, setCompletedHistory] = useState([]);
            const [showAddForm, setShowAddForm] = useState(false);
            const [editingPivot, setEditingPivot] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [alertsEnabled, setAlertsEnabled] = useState(true);
            const [notifiedSystems, setNotifiedSystems] = useState(new Set());
            const [activeTab, setActiveTab] = useState('pivots');
            const [expandedFarms, setExpandedFarms] = useState({});
            const [quickStartPivot, setQuickStartPivot] = useState(null);
            const [expandedSystem, setExpandedSystem] = useState(null);
            const [showNewFarmInput, setShowNewFarmInput] = useState(false);
            const [newFarmName, setNewFarmName] = useState('');
            const [formData, setFormData] = useState({name: '', farm: '', coverage: '', baseRuntime: '', baseDepth: ''});
            const [quickStartDepth, setQuickStartDepth] = useState('');

            useEffect(() => {
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            }, []);

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                activeSystems.forEach(system => {
                    const endTime = new Date(system.endTime);
                    if (endTime <= currentTime && !notifiedSystems.has(system.id) && !system.paused) {
                        setNotifiedSystems(prev => new Set([...prev, system.id]));
                        if (alertsEnabled && 'Notification' in window && Notification.permission === 'granted') {
                            new Notification('Irrigation Complete', {body: `${system.name} has finished irrigating (${system.appliedDepth}" applied)`});
                        }
                    }
                });
            }, [currentTime, activeSystems, alertsEnabled, notifiedSystems]);

            useEffect(() => {
                const loadData = () => {
                    try {
                        const p = storage.get('irrigation-pivots');
                        const a = storage.get('irrigation-active');
                        const h = storage.get('irrigation-history');
                        if (p?.value) setPivots(JSON.parse(p.value));
                        if (a?.value) setActiveSystems(JSON.parse(a.value));
                        if (h?.value) setCompletedHistory(JSON.parse(h.value));
                    } catch (e) { console.log('No data'); }
                };
                loadData();
                const interval = setInterval(loadData, 5000);
                return () => clearInterval(interval);
            }, []);

            const savePivots = (newPivots) => { setPivots(newPivots); storage.set('irrigation-pivots', JSON.stringify(newPivots)); };
            const saveActiveSystems = (newActive) => { setActiveSystems(newActive); storage.set('irrigation-active', JSON.stringify(newActive)); };
            const saveHistory = (newHistory) => { setCompletedHistory(newHistory); storage.set('irrigation-history', JSON.stringify(newHistory)); };

            const handleSavePivot = () => {
                const farmName = showNewFarmInput ? newFarmName : formData.farm;
                if (!formData.name || !farmName || !formData.coverage || !formData.baseRuntime || !formData.baseDepth) {
                    alert('Please fill in all fields');
                    return;
                }
                const newPivot = {id: editingPivot?.id || Date.now(), name: formData.name, farm: farmName, coverage: parseFloat(formData.coverage), baseRuntime: parseFloat(formData.baseRuntime), baseDepth: parseFloat(formData.baseDepth)};
                if (editingPivot) { savePivots(pivots.map(p => p.id === editingPivot.id ? newPivot : p)); } else { savePivots([...pivots, newPivot]); }
                setFormData({name: '', farm: '', coverage: '', baseRuntime: '', baseDepth: ''});
                setShowAddForm(false);
                setEditingPivot(null);
                setShowNewFarmInput(false);
                setNewFarmName('');
            };

            const calculateIrrigation = (pivot, desiredDepth) => {
                const speedPercent = (pivot.baseDepth / desiredDepth) * 100;
                const actualRuntime = (desiredDepth / pivot.baseDepth) * pivot.baseRuntime;
                const adjustedRuntime = (pivot.coverage / 100) * actualRuntime;
                return {speedPercent: Math.round(speedPercent), actualRuntime: adjustedRuntime};
            };

            const handleQuickStart = (pivot) => {
                if (!quickStartDepth) { alert('Please enter water depth'); return; }
                const desiredDepth = parseFloat(quickStartDepth);
                const calc = calculateIrrigation(pivot, desiredDepth);
                const startTime = new Date();
                const endTime = new Date(startTime.getTime() + calc.actualRuntime * 60 * 60 * 1000);
                const newActive = {...pivot, startTime: startTime.toISOString(), endTime: endTime.toISOString(), appliedDepth: desiredDepth, speedPercent: calc.speedPercent, actualRuntime: calc.actualRuntime};
                saveActiveSystems([...activeSystems, newActive]);
                setQuickStartPivot(null);
                setQuickStartDepth('');
            };

            const pauseSystem = (system) => {
                const now = new Date();
                const endTime = new Date(system.endTime);
                const remainingMs = endTime - now;
                const updatedSystem = {...system, paused: true, pausedAt: now.toISOString(), remainingMs};
                saveActiveSystems(activeSystems.map(s => s.id === system.id ? updatedSystem : s));
            };

            const resumeSystem = (system) => {
                const now = new Date();
                const newEndTime = new Date(now.getTime() + system.remainingMs);
                const updatedSystem = {...system, paused: false, pausedAt: null, endTime: newEndTime.toISOString()};
                delete updatedSystem.remainingMs;
                saveActiveSystems(activeSystems.map(s => s.id === system.id ? updatedSystem : s));
            };

            const stopSystem = (system) => {
                const historyEntry = {...system, completedAt: new Date().toISOString(), completed: isComplete(system.endTime) && !system.paused};
                saveHistory([historyEntry, ...completedHistory]);
                saveActiveSystems(activeSystems.filter(s => s.id !== system.id));
                setNotifiedSystems(prev => { const newSet = new Set(prev); newSet.delete(system.id); return newSet; });
            };

            const markAsComplete = (system) => {
                const historyEntry = {...system, completedAt: new Date().toISOString(), completed: true, manuallyCompleted: true};
                saveHistory([historyEntry, ...completedHistory]);
                saveActiveSystems(activeSystems.filter(s => s.id !== system.id));
                setNotifiedSystems(prev => { const newSet = new Set(prev); newSet.delete(system.id); return newSet; });
            };

            const deletePivot = (id) => { if (confirm('Delete this pivot?')) { savePivots(pivots.filter(p => p.id !== id)); saveActiveSystems(activeSystems.filter(s => s.id !== id)); } };

            const editPivot = (pivot) => {
                setEditingPivot(pivot);
                setFormData({name: pivot.name, farm: pivot.farm || '', coverage: pivot.coverage.toString(), baseRuntime: pivot.baseRuntime.toString(), baseDepth: pivot.baseDepth.toString()});
                setShowNewFarmInput(false);
                setNewFarmName('');
                setShowAddForm(true);
            };

            const handleFarmChange = (e) => {
                const value = e.target.value;
                if (value === '__new__') { setShowNewFarmInput(true); setFormData({...formData, farm: ''}); setNewFarmName(''); }
                else { setShowNewFarmInput(false); setNewFarmName(''); setFormData({...formData, farm: value}); }
            };

            const handleCancelNewFarm = () => { setShowNewFarmInput(false); setNewFarmName(''); setFormData({...formData, farm: ''}); };
            const formatTime = (date) => new Date(date).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true});
            const formatDate = (date) => new Date(date).toLocaleDateString('en-US', {month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'});

            const getTimeRemaining = (endTime, paused, pausedAt) => {
                if (paused) {
                    const pausedTime = new Date(pausedAt);
                    const end = new Date(endTime);
                    const diff = end - pausedTime;
                    const hours = Math.floor(diff / 36e5);
                    const minutes = Math.floor((diff % 36e5) / 6e4);
                    return `${hours}h ${minutes}m`;
                }
                const end = new Date(endTime);
                const diff = end - currentTime;
                if (diff <= 0) return 'Complete';
                const hours = Math.floor(diff / 36e5);
                const minutes = Math.floor((diff % 36e5) / 6e4);
                return `${hours}h ${minutes}m`;
            };

            const isComplete = (endTime) => new Date(endTime) <= currentTime;
            const clearHistory = () => { if (confirm('Clear all history?')) { setCompletedHistory([]); storage.delete('irrigation-history'); } };
            const toggleFarm = (farm) => { setExpandedFarms(prev => ({...prev, [farm]: !prev[farm]})); };

            const groupedPivots = pivots.reduce((acc, pivot) => {
                const farm = pivot.farm || 'Uncategorized';
                if (!acc[farm]) acc[farm] = [];
                acc[farm].push(pivot);
                return acc;
            }, {});
            const sortedFarms = Object.keys(groupedPivots).sort();
            const existingFarms = useMemo(() => [...new Set(pivots.map(p => p.farm).filter(Boolean))].sort(), [pivots]);
            const runningCount = activeSystems.length;
            const completingSoon = activeSystems.filter(s => { const diff = new Date(s.endTime) - currentTime; return diff > 0 && diff < 36e5 && !s.paused; }).length;

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="bg-white shadow-sm sticky top-0 z-10">
                        <div className="max-w-6xl mx-auto px-4 py-4">
                            <div className="flex justify-between items-center mb-4">
                                <div><h1 className="text-2xl font-bold text-green-800">Irrigation Scheduler</h1><p className="text-sm text-gray-600">Team Mode</p></div>
                                <button onClick={() => setAlertsEnabled(!alertsEnabled)} className={`p-2 rounded-lg ${alertsEnabled ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-500'}`}>
                                    {alertsEnabled ? <Bell size={20} /> : <BellOff size={20} />}
                                </button>
                            </div>
                            {runningCount > 0 && (
                                <div className="flex gap-4 text-sm mb-4">
                                    <div className="bg-blue-50 px-3 py-2 rounded-lg"><span className="font-semibold text-blue-700">{runningCount}</span> <span className="text-blue-600">running</span></div>
                                    {completingSoon > 0 && <div className="bg-orange-50 px-3 py-2 rounded-lg"><span className="font-semibold text-orange-700">{completingSoon}</span> <span className="text-orange-600">completing soon</span></div>}
                                </div>
                            )}
                            <div className="flex gap-1 border-b border-gray-200">
                                <button onClick={() => setActiveTab('pivots')} className={`px-4 py-2 font-medium transition ${activeTab === 'pivots' ? 'text-green-700 border-b-2 border-green-700' : 'text-gray-500 hover:text-gray-700'}`}>Pivot Systems</button>
                                <button onClick={() => setActiveTab('active')} className={`px-4 py-2 font-medium transition ${activeTab === 'active' ? 'text-green-700 border-b-2 border-green-700' : 'text-gray-500 hover:text-gray-700'}`}>
                                    Active Systems {runningCount > 0 && <span className="ml-1 bg-blue-500 text-white text-xs px-2 py-0.5 rounded-full">{runningCount}</span>}
                                </button>
                                <button onClick={() => setActiveTab('history')} className={`px-4 py-2 font-medium transition ${activeTab === 'history' ? 'text-green-700 border-b-2 border-green-700' : 'text-gray-500 hover:text-gray-700'}`}>History</button>
                            </div>
                        </div>
                    </div>
                    <div className="max-w-6xl mx-auto px-4 py-6 pb-24">
                        {activeTab === 'pivots' && (
                            <div>
                                {showAddForm && (
                                    <div className="bg-white rounded-lg shadow-sm p-4 mb-4">
                                        <h3 className="font-semibold mb-3">{editingPivot ? 'Edit' : 'Add'} Pivot</h3>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="col-span-2">
                                                <label className="block text-xs text-gray-600 mb-1">Farm Name</label>
                                                {showNewFarmInput ? (
                                                    <div className="flex gap-2">
                                                        <input type="text" value={newFarmName} onChange={(e) => setNewFarmName(e.target.value)} className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Enter new farm name" autoFocus />
                                                        <button type="button" onClick={handleCancelNewFarm} className="px-3 py-2 bg-gray-200 rounded-lg text-sm hover:bg-gray-300">Back</button>
                                                    </div>
                                                ) : (
                                                    <select value={formData.farm} onChange={handleFarmChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                        <option value="">Select a farm...</option>
                                                        <option value="__new__">+ Add New Farm</option>
                                                        {existingFarms && existingFarms.length > 0 && <option disabled>──────────</option>}
                                                        {existingFarms && existingFarms.map(farm => <option key={farm} value={farm}>{farm}</option>)}
                                                    </select>
                                                )}
                                            </div>
                                            <input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="px-3 py-2 border rounded-lg text-sm col-span-2" placeholder="Pivot Name" />
                                            <input type="number" value={formData.coverage} onChange={(e) => setFormData({...formData, coverage: e.target.value})} className="px-3 py-2 border rounded-lg text-sm" placeholder="Circle %" />
                                            <input type="number" step="0.1" value={formData.baseRuntime} onChange={(e) => setFormData({...formData, baseRuntime: e.target.value})} className="px-3 py-2 border rounded-lg text-sm" placeholder="Runtime (hrs) @ 100%" />
                                            <input type="number" step="0.01" value={formData.baseDepth} onChange={(e) => setFormData({...formData, baseDepth: e.target.value})} className="px-3 py-2 border rounded-lg text-sm col-span-2" placeholder="Water depth (inches) @ 100%" />
                                        </div>
                                        <div className="flex gap-2 mt-3">
                                            <button onClick={handleSavePivot} className="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">Save</button>
                                            <button onClick={() => {setShowAddForm(false); setEditingPivot(null); setFormData({name: '', farm: '', coverage: '', baseRuntime: '', baseDepth: ''}); setShowNewFarmInput(false); setNewFarmName('');}} className="flex-1 bg-gray-300 px-4 py-2 rounded-lg text-sm hover:bg-gray-400">Cancel</button>
                                        </div>
                                    </div>
                                )}
                                {pivots.length === 0 ? (
                                    <div className="bg-white rounded-lg shadow-sm p-8 text-center text-gray-500">No pivot systems yet. Click + to add one.</div>
                                ) : (
                                    <div className="space-y-2">
                                        {sortedFarms.map(farm => (
                                            <div key={farm} className="bg-white rounded-lg shadow-sm overflow-hidden">
                                                <button onClick={() => toggleFarm(farm)} className="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition">
                                                    <div className="flex items-center gap-2">
                                                        {expandedFarms[farm] ? <ChevronDown size={20} /> : <ChevronRight size={20} />}
                                                        <span className="font-semibold text-gray-800">{farm}</span>
                                                        <span className="text-sm text-gray-500">({groupedPivots[farm].length})</span>
                                                    </div>
                                                </button>
                                                {expandedFarms[farm] && (
                                                    <div className="border-t border-gray-100">
                                                        {groupedPivots[farm].sort((a, b) => a.name.localeCompare(b.name)).map(pivot => {
                                                            const isRunning = activeSystems.some(s => s.id === pivot.id);
                                                            const isQuickStarting = quickStartPivot?.id === pivot.id;
                                                            return (
                                                                <div key={pivot.id} className="px-4 py-3 border-b border-gray-50 last:border-b-0 hover:bg-gray-50">
                                                                    <div className="flex items-center justify-between">
                                                                        <div className="flex-1">
                                                                            <div className="flex items-center gap-2">
                                                                                <span className={`w-2 h-2 rounded-full ${isRunning ? 'bg-blue-500' : 'bg-gray-300'}`}></span>
                                                                                <span className="font-medium text-gray-800">{pivot.name}</span>
                                                                            </div>
                                                                            <div className="text-xs text-gray-500 ml-4 mt-1">{pivot.coverage}% circle • {pivot.baseRuntime}h @ 100% = {pivot.baseDepth}"</div>
                                                                        </div>
                                                                        <div className="flex items-center gap-2">
                                                                            {isQuickStarting ? (
                                                                                <div className="flex items-center gap-2">
                                                                                    <input type="number" step="0.01" value={quickStartDepth} onChange={(e) => setQuickStartDepth(e.target.value)} className="w-20 px-2 py-1 border rounded text-sm" placeholder='0.4"' autoFocus />
                                                                                    {quickStartDepth && <span className="text-xs text-green-700 font-semibold">{calculateIrrigation(pivot, parseFloat(quickStartDepth)).speedPercent}%</span>}
                                                                                    <button onClick={() => handleQuickStart(pivot)} className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">Go</button>
                                                                                    <button onClick={() => {setQuickStartPivot(null); setQuickStartDepth('');}} className="text-gray-500 hover:text-gray-700 text-sm">✕</button>
                                                                                </div>
                                                                            ) : (
                                                                                <>
                                                                                    <button onClick={() => setQuickStartPivot(pivot)} disabled={isRunning} className={`px-3 py-1 rounded-lg text-sm font-medium transition ${isRunning ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'}`}>Start</button>
                                                                                    <button onClick={() => editPivot(pivot)} disabled={isRunning} className={`p-2 rounded-lg transition ${isRunning ? 'text-gray-300 cursor-not-allowed' : 'text-blue-600 hover:bg-blue-50'}`} title="Edit"><Edit2 size={16} /></button>
                                                                                    <button onClick={() => deletePivot(pivot.id)} disabled={isRunning} className={`p-2 rounded-lg transition ${isRunning ? 'text-gray-300 cursor-not-allowed' : 'text-red-600 hover:bg-red-50'}`} title="Delete"><Trash2 size={16} /></button>
                                                                                </>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                        {activeTab === 'active' && (
                            <div>
                                {activeSystems.length === 0 ? (
                                    <div className="bg-white rounded-lg shadow-sm p-8 text-center text-gray-500">No active irrigation systems</div>
                                ) : (
                                    <div className="space-y-3">
                                        {[...activeSystems].sort((a, b) => new Date(a.endTime) - new Date(b.endTime)).map(system => {
                                            const isExp = expandedSystem === system.id;
                                            const isPaused = system.paused;
                                            const isCompletedNow = isComplete(system.endTime);
                                            return (
                                                <div key={system.id} className="bg-white rounded-lg shadow-sm overflow-hidden">
                                                    <div className="p-4">
                                                        <div className="flex items-start justify-between mb-2">
                                                            <div className="flex-1">
                                                                <div className="flex items-center gap-2">
                                                                    <span className={`w-3 h-3 rounded-full ${isPaused ? 'bg-yellow-500' : isCompletedNow ? 'bg-green-500' : 'bg-blue-500'}`}></span>
                                                                    <h3 className="font-bold text-lg">{system.name}</h3>
                                                                </div>
                                                                <p className="text-sm text-gray-600 ml-5">{system.farm}</p>
                                                            </div>
                                                            <div className="text-right">
                                                                <p className={`font-bold text-lg ${isPaused ? 'text-yellow-700' : isCompletedNow ? 'text-green-700' : 'text-blue-700'}`}>{getTimeRemaining(system.endTime, system.paused, system.pausedAt)}</p>
                                                                {system.paused && <p className="text-xs text-yellow-600">PAUSED</p>}
                                                                {!system.paused && !isCompletedNow && <p className="text-xs text-gray-500">until {formatTime(system.endTime)}</p>}
                                                            </div>
                                                        </div>
                                                        {!system.paused && !isCompletedNow && (
                                                            <div className="mt-3">
                                                                <div className="w-full bg-gray-200 rounded-full h-2">
                                                                    <div className="bg-blue-600 h-2 rounded-full transition-all duration-1000" style={{width: `${Math.min(100, Math.max(0, ((new Date() - new Date(system.startTime)) / (new Date(system.endTime) - new Date(system.startTime))) * 100))}%`}}></div>
                                                                </div>
                                                            </div>
                                                        )}
                                                        <div className="flex gap-2 mt-3">
                                                            {system.paused ? (
                                                                <button onClick={() => resumeSystem(system)} className="flex-1 bg-green-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-green-700">Resume</button>
                                                            ) : (
                                                                <button onClick={() => pauseSystem(system)} className="flex-1 bg-yellow-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-yellow-700 flex items-center justify-center gap-1"><Pause size={16} /> Pause</button>
                                                            )}
                                                            <button onClick={() => markAsComplete(system)} className="flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-700 flex items-center justify-center gap-1"><CheckCircle size={16} /> Complete</button>
                                                            <button onClick={() => stopSystem(system)} className="px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm hover:bg-red-200">Stop Early</button>
                                                        </div>
                                                        <button onClick={() => setExpandedSystem(isExp ? null : system.id)} className="w-full text-xs text-gray-500 mt-3 hover:text-gray-700">{isExp ? '▲ Hide details' : '▼ Show details'}</button>
                                                        {isExp && (
                                                            <div className="mt-3 pt-3 border-t border-gray-200 text-sm space-y-1">
                                                                <p className="text-gray-700">Started: <span className="font-semibold">{formatTime(system.startTime)}</span></p>
                                                                <p className="text-gray-700">Timer Speed: <span className="font-semibold">{system.speedPercent}%</span></p>
                                                                <p className="text-gray-700">Water Applied: <span className="font-semibold">{system.appliedDepth}"</span></p>
                                                                <p className="text-gray-700">Total Runtime: <span className="font-semibold">{system.actualRuntime.toFixed(1)} hours</span></p>
                                                                <p className="text-gray-600 text-xs">Circle: {system.coverage}%</p>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        )}
                        {activeTab === 'history' && (
                            <div>
                                {completedHistory.length === 0 ? (
                                    <div className="bg-white rounded-lg shadow-sm p-8 text-center text-gray-500">No irrigation history yet</div>
                                ) : (
                                    <>
                                        <div className="flex justify-between items-center mb-4">
                                            <p className="text-sm text-gray-600">{completedHistory.length} total entries</p>
                                            <button onClick={clearHistory} className="text-sm text-red-600 hover:text-red-800">Clear All</button>
                                        </div>
                                        <div className="space-y-2">
                                            {completedHistory.slice(0, 50).map((entry, idx) => (
                                                <div key={idx} className="bg-white rounded-lg shadow-sm p-3">
                                                    <div className="flex justify-between items-start">
                                                        <div><h4 className="font-semibold text-gray-800">{entry.name}</h4><p className="text-xs text-gray-500">{entry.farm}</p></div>
                                                        <span className="text-xs text-gray-500">{formatDate(entry.completedAt)}</span>
                                                    </div>
                                                    <div className="text-sm text-gray-600 mt-2">
                                                        <p>Applied: {entry.appliedDepth}" at {entry.speedPercent}% • {entry.actualRuntime.toFixed(1)}h</p>
                                                        <p className={entry.manuallyCompleted ? 'text-blue-600 text-xs' : entry.completed ? 'text-green-600 text-xs' : 'text-orange-600 text-xs'}>
                                                            {entry.manuallyCompleted ? '✓ Manually completed' : entry.completed ? '✓ Completed' : '⚠ Stopped early'}
                                                        </p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                    </div>
                    {activeTab === 'pivots' && (
                        <button onClick={() => setShowAddForm(true)} className="fixed bottom-6 right-6 bg-green-600 text-white p-4 rounded-full shadow-lg hover:bg-green-700 transition z-20">
                            <Plus size={24} />
                        </button>
                    )}
                </div>
            );
        }

        ReactDOM.render(<IrrigationScheduler />, document.getElementById('root'));
    </script>
</body>
</html>
